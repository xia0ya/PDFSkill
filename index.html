<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFæ ‡ç­¾æ·»åŠ å·¥å…· - æµè§ˆå™¨ç‰ˆ</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 10px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            display: none;
        }
        .instructions {
            background-color: #e7f3fe;
            border: 1px solid #b3d9ff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“„ PDFæ ‡ç­¾æ·»åŠ å·¥å…· (æµè§ˆå™¨ç‰ˆ)</h1>
        
        <div class="instructions">
            <h3>ä½¿ç”¨è¯´æ˜ï¼š</h3>
            <ul>
                <li>æ‰€æœ‰å¤„ç†å‡åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œæ–‡ä»¶ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</li>
                <li>æ”¯æŒæ‰¹é‡å¤„ç†å¤šä¸ªPDFæ–‡ä»¶</li>
                <li>é€‰æ‹©æ ‡ç­¾ä½ç½®ï¼ˆ9ä¸ªé¢„è®¾ä½ç½®ï¼‰</li>
                <li>å¯è‡ªå®šä¹‰æ ‡ç­¾æ–‡æœ¬ã€å­—ä½“ã€é¢œè‰²å’Œåç§»</li>
            </ul>
        </div>
        
        <div class="warning">
            <strong>æ³¨æ„ï¼š</strong> ä¸ºé¿å…è¦†ç›–åŸæœ‰å†…å®¹ï¼Œå»ºè®®ä½¿ç”¨è¾ƒå°å­—ä½“(8-10å·)å¹¶å°†æ ‡ç­¾æ”¾ç½®åœ¨é¡µé¢è§’è½ã€‚
        </div>
        
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="pdfFile">é€‰æ‹©PDFæ–‡ä»¶ (æ”¯æŒå¤šé€‰):</label>
                <input type="file" id="pdfFile" name="pdfFile" accept=".pdf" multiple required>
            </div>
            
            <div class="form-group">
                <label for="labelText">æ ‡ç­¾æ–‡æœ¬:</label>
                <input type="text" id="labelText" name="labelText" value="Made in China">
            </div>
            
            <div class="form-group">
                <label for="position">æ ‡ç­¾ä½ç½®:</label>
                <select id="position" name="position">
                    <option value="top-right">å³ä¸Šè§’</option>
                    <option value="top-left">å·¦ä¸Šè§’</option>
                    <option value="top-center">é¡¶éƒ¨å±…ä¸­</option>
                    <option value="middle-right">å³ä¾§ä¸­é—´</option>
                    <option value="middle-left">å·¦ä¾§ä¸­é—´</option>
                    <option value="middle-center">æ­£ä¸­é—´</option>
                    <option value="bottom-right">å³ä¸‹è§’</option>
                    <option value="bottom-left">å·¦ä¸‹è§’</option>
                    <option value="bottom-center">åº•éƒ¨å±…ä¸­</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="fontSize">å­—ä½“å¤§å°:</label>
                <input type="number" id="fontSize" name="fontSize" value="8" min="6" max="20">
            </div>
            
            <div class="form-group">
                <label for="fontColor">å­—ä½“é¢œè‰²:</label>
                <input type="color" id="fontColor" name="fontColor" value="#FF0000">
            </div>
            
            <div class="form-group">
                <label for="xOffset">Xè½´åç§» (-100åˆ°100):</label>
                <input type="number" id="xOffset" name="xOffset" value="0" min="-100" max="100">
            </div>
            
            <div class="form-group">
                <label for="yOffset">Yè½´åç§» (-100åˆ°100):</label>
                <input type="number" id="yOffset" name="yOffset" value="0" min="-100" max="100">
            </div>
            
            <button type="submit">å¤„ç†PDF</button>
        </form>
        
        <div id="result" class="result"></div>
    </div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('pdfFile');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªPDFæ–‡ä»¶');
                return;
            }
            
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `å¼€å§‹å¤„ç†... (å…±${files.length}ä¸ªæ–‡ä»¶)`;
            
            // è·å–å‚æ•°
            const labelText = document.getElementById('labelText').value;
            const position = document.getElementById('position').value;
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const fontColor = document.getElementById('fontColor').value;
            const xOffset = parseInt(document.getElementById('xOffset').value);
            const yOffset = parseInt(document.getElementById('yOffset').value);
            
            try {
                // å¤„ç†æ¯ä¸ªæ–‡ä»¶
                for (let i = 0; i < files.length; i++) {
                    resultDiv.innerHTML = `æ­£åœ¨å¤„ç†: ${files[i].name} (${i+1}/${files.length})`;
                    
                    const arrayBuffer = await files[i].arrayBuffer();
                    const { PDFDocument, rgb, StandardFonts } = PDFLib;
                    
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    
                    // åµŒå…¥å­—ä½“ä»¥ç¡®ä¿ä¸€è‡´æ€§
                    const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                    
                    const pages = pdfDoc.getPages();
                    
                    // è®¡ç®—é¢œè‰²
                    const r = parseInt(fontColor.substr(1, 2), 16) / 255;
                    const g = parseInt(fontColor.substr(3, 2), 16) / 255;
                    const b = parseInt(fontColor.substr(5, 2), 16) / 255;
                    
                    for (const page of pages) {
                        const { width, height } = page.getSize();
                        
                        // è®¡ç®—æ ‡ç­¾ä½ç½® - ä½¿ç”¨æ›´å¤§çš„è¾¹è·ä»¥é¿å…è¦†ç›–å†…å®¹
                        let x, y;
                        const textWidth = font.widthOfTextAtSize(labelText, fontSize);
                        // ä½¿ç”¨æ›´å¤§çš„è¾¹è·ä»¥å‡å°‘è¦†ç›–é£é™©
                        const margin = Math.max(20, 10 + fontSize);

                        switch (position) {
                            case 'top-left':
                                x = margin;
                                y = height - margin - fontSize;
                                break;
                            case 'top-center':
                                x = (width - textWidth) / 2;
                                y = height - margin - fontSize;
                                break;
                            case 'top-right':
                                x = width - textWidth - margin;
                                y = height - margin - fontSize;
                                break;
                            case 'middle-left':
                                x = margin;
                                y = height / 2 - fontSize / 2;
                                break;
                            case 'center':
                                x = (width - textWidth) / 2;
                                y = height / 2 - fontSize / 2;
                                break;
                            case 'middle-right':
                                x = width - textWidth - margin;
                                y = height / 2 - fontSize / 2;
                                break;
                            case 'bottom-left':
                                x = margin;
                                y = margin + fontSize; // æŠ¬é«˜ä¸€ç‚¹é¿å…åœ¨æœ€åº•éƒ¨
                                break;
                            case 'bottom-center':
                                x = (width - textWidth) / 2;
                                y = margin + fontSize;
                                break;
                            case 'bottom-right':
                                x = width - textWidth - margin;
                                y = margin + fontSize;
                                break;
                            default:
                                x = width - textWidth - margin;
                                y = height - margin - fontSize;
                        }

                        // åº”ç”¨åç§»
                        x += xOffset;
                        y += yOffset;

                        // ç¡®ä¿æ ‡ç­¾åœ¨é¡µé¢è¾¹ç•Œå†…ï¼Œå¹¶å¢åŠ é¢å¤–çš„å®‰å…¨è¾¹è·
                        const safeMargin = Math.max(15, fontSize);
                        x = Math.max(safeMargin, Math.min(x, width - textWidth - safeMargin));
                        y = Math.max(safeMargin, Math.min(y, height - safeMargin));

                        // åˆ›å»ºä¸€ä¸ªé€æ˜åº¦è¾ƒä½çš„èƒŒæ™¯çŸ©å½¢æ¥å¢å¼ºå¯¹æ¯”åº¦ï¼Œä½†ä¸å½±å“ä¸‹æ–¹å†…å®¹
                        const textPage = page;
                        
                        // æ·»åŠ æ ‡ç­¾æ–‡æœ¬
                        textPage.drawText(labelText, {
                            x: x,
                            y: y,
                            size: fontSize,
                            font: font,
                            color: rgb(r, g, b),
                            opacity: 0.9, // ç•¥ä½äºå®Œå…¨ä¸é€æ˜ä»¥ç¨å¾®é™ä½è¦†ç›–æ•ˆæœ
                        });
                    }

                    // ä¿å­˜ä¿®æ”¹åçš„PDF
                    const modifiedPdfBytes = await pdfDoc.save();
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `processed_${files[i].name}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                
                resultDiv.innerHTML = `å®Œæˆï¼${files.length}ä¸ªæ–‡ä»¶å·²å¤„ç†å¹¶ä¸‹è½½ã€‚ä¸ºè·å¾—æœ€ä½³æ•ˆæœï¼Œå»ºè®®å°†æ ‡ç­¾æ”¾ç½®åœ¨é¡µé¢è§’è½å¹¶ä½¿ç”¨è¾ƒå°å­—ä½“ã€‚`;
            } catch (error) {
                resultDiv.innerHTML = 'é”™è¯¯: ' + error.message;
                console.error('å¤„ç†é”™è¯¯:', error);
            }
        });
    </script>
</body>
</html>